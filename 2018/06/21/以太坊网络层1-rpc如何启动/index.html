<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="以太坊网络层RPC是如何启动的从入口开始层层进入到网络层。结合源码查看更好。  geth/main.go 程序入口 12345678910// geth is the main entry point into the system if no special subcommand is ran.// It creates a default node based on the command l">
<meta property="og:type" content="article">
<meta property="og:title" content="谢志海的博客">
<meta property="og:url" content="http://yoursite.com/2018/06/21/以太坊网络层1-rpc如何启动/index.html">
<meta property="og:site_name" content="谢志海的博客">
<meta property="og:description" content="以太坊网络层RPC是如何启动的从入口开始层层进入到网络层。结合源码查看更好。  geth/main.go 程序入口 12345678910// geth is the main entry point into the system if no special subcommand is ran.// It creates a default node based on the command l">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/006tKfTcgy1fsk1p0bt99j30gs09ywf2.jpg">
<meta property="og:updated_time" content="2018-06-26T08:39:54.698Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="谢志海的博客">
<meta name="twitter:description" content="以太坊网络层RPC是如何启动的从入口开始层层进入到网络层。结合源码查看更好。  geth/main.go 程序入口 12345678910// geth is the main entry point into the system if no special subcommand is ran.// It creates a default node based on the command l">
<meta name="twitter:image" content="https://ws3.sinaimg.cn/large/006tKfTcgy1fsk1p0bt99j30gs09ywf2.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/06/21/以太坊网络层1-rpc如何启动/"/>





  <title> | 谢志海的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">谢志海的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术改变生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/21/以太坊网络层1-rpc如何启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢志海">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/5211594?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="谢志海的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-21T15:28:20+08:00">
                2018-06-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="以太坊网络层RPC是如何启动的"><a href="#以太坊网络层RPC是如何启动的" class="headerlink" title="以太坊网络层RPC是如何启动的"></a>以太坊网络层RPC是如何启动的</h2><p>从入口开始层层进入到网络层。结合源码查看更好。</p>
<ul>
<li><p>geth/main.go 程序入口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// geth is the main entry point into the system if no special subcommand is ran.</span></span><br><span class="line"><span class="comment">// It creates a default node based on the command line arguments and runs it in</span></span><br><span class="line"><span class="comment">// blocking mode, waiting for it to be shut down.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">geth</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	node := makeFullNode(ctx)</span><br><span class="line">    <span class="comment">// 启动node</span></span><br><span class="line">	startNode(ctx, node)</span><br><span class="line">	node.Wait()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>geth/main.go - func startNode(ctx <em>cli.Context, stack </em>node.Node)部分代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动node</span></span><br><span class="line">utils.StartNode(stack)</span><br></pre></td></tr></table></figure>
</li>
<li><p>cmd/utils/cmd.go - func StartNode(stack *node.Node)部分代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := stack.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    Fatalf(<span class="string">"Error starting protocol stack: %v"</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>node/node.go - func (n *Node) Start() error 部分代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lastly start the configured RPC interfaces</span></span><br><span class="line"><span class="keyword">if</span> err := n.startRPC(services); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, service := <span class="keyword">range</span> services &#123;</span><br><span class="line">        service.Stop()</span><br><span class="line">    &#125;</span><br><span class="line">    running.Stop()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>node/node.go - func (n *Node) startRPC(services map[reflect.Type]Service) error 部分代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := n.startHTTP(n.httpEndpoint, apis, n.config.HTTPModules, n.config.HTTPCors, n.config.HTTPVirtualHosts); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    n.stopIPC()</span><br><span class="line">    n.stopInProc()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>node/node.go - func (n *Node) startHTTP(endpoint string, apis []rpc.API, modules []string, cors []string, vhosts []string) error 部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// startHTTP initializes and starts the HTTP RPC endpoint.</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listener, handler, err := rpc.StartHTTPEndpoint(endpoint, apis, modules, cors, vhosts)</span><br></pre></td></tr></table></figure>
</li>
<li><p>rpc/endpoints.go - func StartHTTPEndpoint(endpoint string, apis []API, modules []string, cors []string, vhosts []string) (net.Listener, *Server, error)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register all the APIs exposed by the services</span></span><br><span class="line">handler := NewServer()</span><br><span class="line"><span class="keyword">for</span> _, api := <span class="keyword">range</span> apis &#123;</span><br><span class="line">    <span class="keyword">if</span> whitelist[api.Namespace] || (<span class="built_in">len</span>(whitelist) == <span class="number">0</span> &amp;&amp; api.Public) &#123;</span><br><span class="line">        <span class="keyword">if</span> err := handler.RegisterName(api.Namespace, api.Service); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        log.Debug(<span class="string">"HTTP registered"</span>, <span class="string">"namespace"</span>, api.Namespace)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// All APIs registered, start the HTTP listener</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    listener net.Listener</span><br><span class="line">    err      error</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> listener, err = net.Listen(<span class="string">"tcp"</span>, endpoint); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> NewHTTPServer(cors, vhosts, handler).Serve(listener)</span><br></pre></td></tr></table></figure>
<p>这里主要涉及三个步骤</p>
<ol>
<li>handler := NewServer()这里新建了一个rpc服务，里面调用了RegisterName注册了对应的api。</li>
<li>listener启动了tcp端口，并对端口进行监听</li>
<li>go NewHTTPServer对handler与listener进行了整合，并运行在单独进程里。</li>
<li>Server.Serve()在Go源码里面调用</li>
</ol>
</li>
</ul>
<h3 id="函数NewHTTPServer分析"><a href="#函数NewHTTPServer分析" class="headerlink" title="函数NewHTTPServer分析"></a>函数NewHTTPServer分析</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewHTTPServer creates a new HTTP RPC server around an API provider.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Deprecated: Server implements http.Handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHTTPServer</span><span class="params">(cors []<span class="keyword">string</span>, vhosts []<span class="keyword">string</span>, srv *Server)</span> *<span class="title">http</span>.<span class="title">Server</span></span> &#123;</span><br><span class="line">	<span class="comment">// Wrap the CORS-handler within a host-handler</span></span><br><span class="line">	handler := newCorsHandler(srv, cors)</span><br><span class="line">	handler = newVHostHandler(vhosts, handler)</span><br><span class="line">	<span class="keyword">return</span> &amp;http.Server&#123;Handler: handler&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Server是rpc服务结构体，根据参数返回包含Handler接口的http.Server指针。Handler用作处理listener的请求。</p>
<p>[<a href="https://golang.org/pkg/net/http/#Server.Serve]" target="_blank" rel="noopener">https://golang.org/pkg/net/http/#Server.Serve]</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">Serve</span><span class="params">(l net.Listener)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Serve accepts incoming connections on the Listener l, creating a new service goroutine for each. The service goroutines read requests and then call srv.Handler to reply to them.</p>
<p>For HTTP/2 support, srv.TLSConfig should be initialized to the provided listener’s TLS Config before calling Serve. If srv.TLSConfig is non-nil and doesn’t include the string “h2” in Config.NextProtos, HTTP/2 support is not enabled.</p>
</blockquote>
<p>[<a href="https://golang.org/pkg/net/http/#Handler]" target="_blank" rel="noopener">https://golang.org/pkg/net/http/#Handler]</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">        ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>A Handler responds to an HTTP request.</p>
<p>ServeHTTP should write reply headers and data to the ResponseWriter and then return. Returning signals that the request is finished; it is not valid to use the ResponseWriter or read from the Request.Body after or concurrently with the completion of the ServeHTTP call.</p>
</blockquote>
<p>要实现Handler接口必须实现ServeHTTP方法。</p>
<h3 id="实现ServeHTTP方法"><a href="#实现ServeHTTP方法" class="headerlink" title="实现ServeHTTP方法"></a>实现ServeHTTP方法</h3><p>回到StartHTTPEndpoint方法可知，handler := NewServer()生成最初的hanlder。</p>
<ul>
<li>rpc/server.go 定义了新建rpc服务的函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewServer will create a new server instance with no registered handlers.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">()</span> *<span class="title">Server</span></span> &#123;</span><br><span class="line">	server := &amp;Server&#123;</span><br><span class="line">		services: <span class="built_in">make</span>(serviceRegistry),</span><br><span class="line">		codecs:   set.New(),</span><br><span class="line">		run:      <span class="number">1</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// register a default service which will provide meta information about the RPC service such as the services and</span></span><br><span class="line">	<span class="comment">// methods it offers.</span></span><br><span class="line">	rpcService := &amp;RPCService&#123;server&#125;</span><br><span class="line">	server.RegisterName(MetadataApi, rpcService)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> server</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>rpc/tpyes.go 定义了rpc服务的结构体Server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server represents a RPC server</span></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">   services serviceRegistry</span><br><span class="line"></span><br><span class="line">   run      <span class="keyword">int32</span></span><br><span class="line">   codecsMu sync.Mutex</span><br><span class="line">   codecs   *set.Set</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>rpc/http.go 定义了rpc结构体Server的方法ServeHTTP-此方法实现了Hanlder接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeHTTP serves JSON-RPC requests over HTTP.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Permit dumb empty requests for remote health-checks (AWS)</span></span><br><span class="line">	<span class="keyword">if</span> r.Method == http.MethodGet &amp;&amp; r.ContentLength == <span class="number">0</span> &amp;&amp; r.URL.RawQuery == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> code, err := validateRequest(r); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		http.Error(w, err.Error(), code)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// All checks passed, create a codec that reads direct from the request body</span></span><br><span class="line">	<span class="comment">// untilEOF and writes the response to w and order the server to process a</span></span><br><span class="line">	<span class="comment">// single request.</span></span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	ctx = context.WithValue(ctx, <span class="string">"remote"</span>, r.RemoteAddr)</span><br><span class="line">	ctx = context.WithValue(ctx, <span class="string">"scheme"</span>, r.Proto)</span><br><span class="line">	ctx = context.WithValue(ctx, <span class="string">"local"</span>, r.Host)</span><br><span class="line"></span><br><span class="line">	body := io.LimitReader(r.Body, maxRequestContentLength)</span><br><span class="line">	codec := NewJSONCodec(&amp;httpReadWriteNopCloser&#123;body, w&#125;)</span><br><span class="line">	<span class="keyword">defer</span> codec.Close()</span><br><span class="line"></span><br><span class="line">	w.Header().Set(<span class="string">"content-type"</span>, contentType)</span><br><span class="line">	srv.ServeSingleRequest(codec, OptionMethodInvocation, ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ServeSingleRequest分析"><a href="#ServeSingleRequest分析" class="headerlink" title="ServeSingleRequest分析"></a>ServeSingleRequest分析</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeSingleRequest reads and processes a single RPC request from the given codec. It will not close the codec unless a non-recoverable error has occurred. Note, this method will return after a single request has been processed!</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">ServeSingleRequest</span><span class="params">(codec ServerCodec, options CodecOption, ctx context.Context)</span></span> &#123;</span><br><span class="line">	s.serveRequest(codec, <span class="literal">true</span>, options, ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>serveRequest首先读取request，http连接中处理完一个请求就回返回。singleShot为true是短连接，false为长连接。</p>
<p>serverRequest结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serverRequest is an incoming request</span></span><br><span class="line"><span class="keyword">type</span> serverRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	id            <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	svcname       <span class="keyword">string</span></span><br><span class="line">	callb         *callback</span><br><span class="line">	args          []reflect.Value</span><br><span class="line">	isUnsubscribe <span class="keyword">bool</span></span><br><span class="line">	err           Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serveRequest will reads requests from the codec, calls the RPC callback and</span></span><br><span class="line"><span class="comment">// writes the response to the given codec.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If singleShot is true it will process a single request, otherwise it will handle</span></span><br><span class="line"><span class="comment">// requests until the codec returns an error when reading a request (in most cases</span></span><br><span class="line"><span class="comment">// an EOF). It executes requests in parallel when singleShot is false.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">serveRequest</span><span class="params">(codec ServerCodec, singleShot <span class="keyword">bool</span>, options CodecOption, ctx context.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	</span><br><span class="line">    ...</span><br><span class="line">    	reqs, batch, err := s.readRequest(codec)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// If a parsing error occurred, send an error</span></span><br><span class="line">			<span class="keyword">if</span> err.Error() != <span class="string">"EOF"</span> &#123;</span><br><span class="line">				log.Debug(fmt.Sprintf(<span class="string">"read error %v\n"</span>, err))</span><br><span class="line">				codec.Write(codec.CreateErrorResponse(<span class="literal">nil</span>, err))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Error or end of stream, wait for requests and tear down</span></span><br><span class="line">			pend.Wait()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// If a single shot request is executing, run and return immediately</span></span><br><span class="line">		<span class="keyword">if</span> singleShot &#123;</span><br><span class="line">			<span class="keyword">if</span> batch &#123;</span><br><span class="line">				s.execBatch(ctx, codec, reqs)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				s.exec(ctx, codec, reqs[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// For multi-shot connections, start a goroutine to serve and loop back</span></span><br><span class="line">		pend.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(reqs []*serverRequest, batch <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> pend.Done()</span><br><span class="line">			<span class="keyword">if</span> batch &#123;</span><br><span class="line">				s.execBatch(ctx, codec, reqs)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				s.exec(ctx, codec, reqs[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(reqs, batch)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>singleShot用于http连接、multiShot用于ipc连接。</li>
<li>batch用于一次请求中提交多个命令，根据官方文档不会提高效率。</li>
</ul>
<p>[<a href="https://github.com/ethereum/wiki/wiki/JavaScript-API#batch-requests]" target="_blank" rel="noopener">https://github.com/ethereum/wiki/wiki/JavaScript-API#batch-requests]</a></p>
<blockquote>
<p>Batch requests allow queuing up requests and processing them at once.</p>
<p><strong>Note</strong> Batch requests are not faster! In fact making many requests at once will in some cases be faster, as requests are processed asynchronously. Batch requests are mainly useful to ensure the serial processing of requests.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> batch = web3.createBatch();</span><br><span class="line">batch.add(web3.eth.getBalance.request(<span class="string">'0x0000000000000000000000000000000000000000'</span>, <span class="string">'latest'</span>, callback));</span><br><span class="line">batch.add(web3.eth.contract(abi).at(address).balance.request(address, callback2));</span><br><span class="line">batch.execute();</span><br></pre></td></tr></table></figure>
<h3 id="exec分析"><a href="#exec分析" class="headerlink" title="exec分析"></a>exec分析</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exec executes the given request and writes the result back using the codec.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">exec</span><span class="params">(ctx context.Context, codec ServerCodec, req *serverRequest)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> response <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">var</span> callback <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	<span class="title">if</span> <span class="title">req</span>.<span class="title">err</span> != <span class="title">nil</span></span> &#123;</span><br><span class="line">		response = codec.CreateErrorResponse(&amp;req.id, req.err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		response, callback = s.handle(ctx, codec, req)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := codec.Write(response); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(fmt.Sprintf(<span class="string">"%v\n"</span>, err))</span><br><span class="line">		codec.Close()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// when request was a subscribe request this allows these subscriptions to be actived</span></span><br><span class="line">	<span class="keyword">if</span> callback != <span class="literal">nil</span> &#123;</span><br><span class="line">		callback()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实则调用handler</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handle executes a request and returns the response from the callback.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">handle</span><span class="params">(ctx context.Context, codec ServerCodec, req *serverRequest)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// execute RPC method and return result</span></span><br><span class="line">	reply := req.callb.method.Func.Call(arguments)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(reply) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> codec.CreateResponse(req.id, <span class="literal">nil</span>), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> req.callb.errPos &gt;= <span class="number">0</span> &#123; <span class="comment">// test if method returned an error</span></span><br><span class="line">		<span class="keyword">if</span> !reply[req.callb.errPos].IsNil() &#123;</span><br><span class="line">			e := reply[req.callb.errPos].Interface().(error)</span><br><span class="line">			res := codec.CreateErrorResponse(&amp;req.id, &amp;callbackError&#123;e.Error()&#125;)</span><br><span class="line">			<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> codec.CreateResponse(req.id, reply[<span class="number">0</span>].Interface()), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="![image](https://github.com/ZtesoftCS/go-ethereum-code-analysis/raw/master/picture/rpc_1.png">rpc源码分析</a>)</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fsk1p0bt99j30gs09ywf2.jpg" alt="image"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/21/以太坊研究clef/" rel="next" title="">
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/22/以太坊网络层2-调试/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars1.githubusercontent.com/u/5211594?s=460&v=4"
                alt="谢志海" />
            
              <p class="site-author-name" itemprop="name">谢志海</p>
              <p class="site-description motion-element" itemprop="description">任职于腾讯，聊一聊区块链、Nodejs、Vue、Docker与新技术。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

                    		<div class="category-all">
                    		  <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/以太坊/">以太坊</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a></li></ul>
                    		</div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/VinceXie" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:274167515@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://wpa.qq.com/msgrd?v=3&uin=274167515&site=qq&menu=yes" target="_blank" title="QQ">
                      
                        <i class="fa fa-fw fa-qq"></i></a>
                  </span>
                
            </div>
          



          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://web3js.readthedocs.io/en/1.0/index.html" title="以太坊web3.js" target="_blank">以太坊web3.js</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#以太坊网络层RPC是如何启动的"><span class="nav-number">1.</span> <span class="nav-text">以太坊网络层RPC是如何启动的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#函数NewHTTPServer分析"><span class="nav-number">1.1.</span> <span class="nav-text">函数NewHTTPServer分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现ServeHTTP方法"><span class="nav-number">1.2.</span> <span class="nav-text">实现ServeHTTP方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServeSingleRequest分析"><span class="nav-number">1.3.</span> <span class="nav-text">ServeSingleRequest分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exec分析"><span class="nav-number">1.4.</span> <span class="nav-text">exec分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">1.5.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">谢志海</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
